<!DOCTYPE html>
<html>
    <head>
        <title>Main</title>
        <script src="Decoy.js" type="text/javascript"></script>
        <script src="jspsych-6.1.0/jspsych.js" type="text/javascript"></script>
        <script src="jspsych-6.1.0/plugins/jspsych-html-keyboard-response.js" type="text/javascript"></script>
        <!--  
            Might be useful later (call other jsPsych functions/plug ins)
            <script src="jspsych-6.1.0/plugins/jspsych-html-button-response.js" type="text/javascript"></script>
            <script src="jspsych-6.1.0/plugins/jspsych-image-keyboard-response.js" type="text/javascript"></script>
            <script src="jspsych-6.1.0/plugins/jspsych-instructions.js" type="text/javascript"></script>
            <script src="jspsych-6.1.0/plugins/jspsych-survey-text.js" type="text/javascript"></script>
        -->    
        <link href="jspsych-6.1.0/css/jspsych.css" rel="stylesheet" type="text/css"></link>
      </head>
      <body></body>
      <script>

        var timeline = [];        

        var urlParams = new URLSearchParams(window.location.search);

        // Check function...
        if (atob(urlParams.get('userid')) === "00000000"){
            btrialcountmax = 5;
            btrialcount = btrialcountmax;
            demo = 1;
        }

        allTrialsJson = {"Trials": [] };
	    var newForm = document.createElement("form"); 
	    newForm.action="RecordResults.cgi";
	    newForm.method="POST";
	    newForm.id="FResponses";
	    newForm.name="FResponses";
	    newForm.style="display:hidden;position:absolute;top:-12rem;";
	    newForm.innerHTML = '<input type="text" id="Responses" name="Responses" maxlength="1000000"><input type="text" id="userid" name="userid" maxlength="1000"><input type="text" id="sc" name="sc" maxlength="1000">';

        // Determine coupling condition (0 = low coupling; 1 = high coupling)
        var coupling_condition = Math.floor(Math.random() * 2);
        if(coupling_condition > 0) {
			coupling = "Low coupling";
		} else {
            coupling = "High coupling"; 
        }

        var phantom_condition = Math.floor(Math.random() * 3);
        if(phantom_condition == 0) {
            phantom_condition = "Highly_desirable";
        } else if (phantom_condition == 1) {
            phantom_condition = "Weakly_desirable";
        } else {
            phantom_condition = "Undesirable";
        }


        var welcome = {
		    type: "html-keyboard-response",
		    stimulus: "<h2>Welcome to the experiment!</h2>" +
				"<div style='position:absolute;top:85%;width:100%;display:table;left:0;'><h3 style='display:table-cell;'>"+
				"Press any key to continue</h3></div>",
		    choices: jsPsych.ALL_KEYS, 
		    trial_duration: 5000,
            on_finish: function(){

                console.log("coupling condition: " + coupling)

                // Capture participants demographic data
                // and send it to 'allTrialsJson' file. 
                document.body.appendChild(newForm);
				var urlParams = new URLSearchParams(window.location.search);
				document.getElementById("userid").value = atob(urlParams.get('userid'));
				document.getElementById("sc").value = urlParams.get('sc');
				var today = new Date();
				var dd = String(today.getDate()).padStart(2, '0');
				var mm = String(today.getMonth() + 1).padStart(2, '0'); //January is 0!
				var yyyy = today.getFullYear();
				newTrialJson = {
					"Age": atob(urlParams.get('ua')),
					"Gender": atob(urlParams.get('ug')),
					"Ethnicity": atob(urlParams.get('ue')),
                    "Race": atob(urlParams.get('ur')),
					"Date": mm + '/' + dd + '/' + yyyy,
					"User_PID": atob(urlParams.get('userid')),
					"Survey_ID": urlParams.get('sc'),
					"User_email": atob(urlParams.get('uem')),
                    "Coupling": coupling, 
                    "Phantom_condition": phantom_condition
					//"Task_Order": exp_order //String.fromCharCode(taskOrder[0] + 65) + String.fromCharCode(taskOrder[2] + 65) //+ String.fromCharCode(taskOrder[1] + 65)		
				};
				
				allTrialsJson['Trials'].push(newTrialJson); 
                // Check function...
				document.body.classList.add('bodyOClass');

                // Add decoy file to timeline.
                Decoy(timeline); 

            }
        };

        // Adding files/events to experiment timeline.
        timeline.push(welcome);
        //timeline.push(taskOrderScreen());

        jsPsych.init({
		    timeline: timeline,
		    default_iti: 0,
		    on_finish: function() {
		    jsPsych.data.displayData();
		
		    }
        });
      </script>
</html>
<!-- 
    Notes: 
    - Check if we need catch trials (4 + 3 =?).
    - Work out how to randomize position of (option A, B, and C).
    - Same product can't be shown twice in the same block.
 -->